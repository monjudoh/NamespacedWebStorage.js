<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: NamespacedWebStorage.js</title>
    
    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">
    
    <h1 class="page-title">Source: NamespacedWebStorage.js</h1>
    
    


    
    <section>
        <article>
            <pre class="prettyprint source"><code>/*
 * NamespacedWebStorage.js
 *
 * https://github.com/monjudoh/NamespacedWebStorage.js
 * version: 0.0.2
 *
 * Copyright (c) 2013 monjudoh
 * Dual licensed under the MIT (MIT-LICENSE.txt)
 * and GPL (GPL-LICENSE.txt) licenses.
 */
/**
 * @module NamespacedWebStorage
 * @version 0.0.2
 * @author monjudoh
 * @copyright (c) 2013 monjudoh&lt;br/>
 * Dual licensed under the MIT (MIT-LICENSE.txt)&lt;br/>
 * and GPL (GPL-LICENSE.txt) licenses.
 * @see https://github.com/monjudoh/NamespacedWebStorage.js
 * @see NamespacedWebStorage
 */
define('NamespacedWebStorage',
[],
function () {
  /**
   * @name NamespacedWebStorage
   * @param {string} primaryNamespace
   * @param {Array.&lt;string>=} restNamespaces
   * @param {Storage=} storage 保存先のStorage。デフォルトはlocalStorage
   * @constructor
   */
  function NamespacedWebStorage(primaryNamespace,restNamespaces,storage){
    var namespaces = (restNamespaces || []).slice();
    namespaces.unshift(primaryNamespace);
    this.namespaces = namespaces;
    this.storage = storage || localStorage;
  }
  var proto = NamespacedWebStorage.prototype;
  function key2FullKey(key){
    return this.namespaces.join('.') + '.' + key;
  }
  /**
   * @name getItem
   * @memberOf NamespacedWebStorage
   * @function
   *
   * @param {string} key
   * @returns {*}
   * @description インスタンスのnamespace階層配下にてkeyに対応する値を取得する
   */
  proto.getItem = function getItem(key){
    var fullKey = key2FullKey.call(this,key);
    return JSON.parse((this.storage[fullKey] || '{}')).value;
  };
  /**
   * @name setItem
   * @memberOf NamespacedWebStorage
   * @function
   *
   * @param {string} key
   * @param {*} data JSON化可能な任意の型のデータ
   * @description インスタンスのnamespace階層配下にてkeyに対応する値を設定する。生のWebStorageと違い文字列型以外も扱える。
   */
  proto.setItem = function setItem(key,data){
    var fullKey = key2FullKey.call(this,key);
    var json = JSON.stringify({
      value:data,
      timestamp:Date.now()
    });
    this.storage[fullKey] = json;
  };
  /**
   * @name removeItem
   * @memberOf NamespacedWebStorage
   * @function
   *
   * @param {string} key
   * @description インスタンスのnamespace階層配下にてkeyに対応する値を削除する。
   */
  proto.removeItem = function removeItem(key) {
    var fullKey = key2FullKey.call(this,key);
    delete this.storage[fullKey];
  };
  /**
   * @name truncate
   * @memberOf NamespacedWebStorage
   * @function
   *
   * @param {number} number 残す個数
   * @param {number=} level namespace階層。デフォルト値は1
   * @description 指定したnamespace階層配下にて、記録日時が新しい順にnumber個のnamespaceを残して残りを削除する。
   */
  proto.truncate = function truncate(number,level) {
    level = level !== undefined ? level : 1;
    var keyPrefix = this.namespaces.slice(0,level).join('.') + '.';
    var storage = this.storage;
    var keys = Object.keys(storage).filter(function(key){
      return key.indexOf(keyPrefix) === 0;
    });
    var namespace2keys = Object.create(null);
    keys.forEach(function(key){
      var nextLevelNamespace = key.slice(keyPrefix.length).match(/^[^.]+/)[0];
      if (!namespace2keys[nextLevelNamespace]) {
        namespace2keys[nextLevelNamespace] = [];
      }
      namespace2keys[nextLevelNamespace].push(key);
    });
    var namespaces = Object.keys(namespace2keys);
    var namespace2latestTimestamp = Object.create(null);
    namespaces.forEach(function(namespace){
      var timestamps = namespace2keys[namespace].map(function(key){
        return JSON.parse(storage[key]).timestamp;
      });
      timestamps.push(0);
      timestamps.push(0);
      namespace2latestTimestamp[namespace] = Math.max.apply(Math,timestamps);
    });
    namespaces.sort(function(namespace1,namespace2){
      var table = namespace2latestTimestamp;
      return table[namespace2] - table[namespace1];
    });
    var namespaces4truncate = namespaces.slice(number);
    namespaces4truncate.forEach(function(namespace){
      namespace2keys[namespace].forEach(function(key){
        delete storage[key];
      });
    });
  };
  return NamespacedWebStorage;
});</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Modules</h3><ul><li><a href="module-NamespacedWebStorage.html">NamespacedWebStorage</a></li></ul><h3>Classes</h3><ul><li><a href="NamespacedWebStorage.html">NamespacedWebStorage</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.0-dev</a> on Fri Sep 20 2013 14:53:35 GMT+0900 (JST)
</footer>

<script> prettyPrint(); </script>
</body>
</html>
